<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>æ ¡å›­åº”æ€¥å“åº”ç³»ç»Ÿ - ä¸»é¡µé¢</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: #f5f7fa;
        }
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .header h1 {
            font-size: 24px;
            margin-bottom: 10px;
        }
        .user-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .nav {
            background: white;
            padding: 15px 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }
        .nav-btn {
            padding: 10px 20px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }
        .nav-btn:hover {
            background: #5568d3;
            transform: translateY(-2px);
        }
        .nav-btn.active {
            background: #764ba2;
        }
        .container {
            max-width: 1200px;
            margin: 20px auto;
            padding: 0 20px;
        }
        .content {
            background: white;
            border-radius: 8px;
            padding: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            min-height: 500px;
        }
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
        }
        .stat-card h3 {
            font-size: 32px;
            margin-bottom: 10px;
        }
        .stat-card p {
            opacity: 0.9;
        }
        .btn {
            padding: 10px 20px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }
        .btn:hover {
            background: #5568d3;
        }
        .btn-danger {
            background: #e74c3c;
        }
        .btn-danger:hover {
            background: #c0392b;
        }
        .btn-success {
            background: #27ae60;
        }
        .btn-success:hover {
            background: #229954;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }
        th {
            background: #f8f9fa;
            font-weight: 600;
        }
        .status-badge {
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            display: inline-block;
        }
        .status-pending { background: #fff3cd; color: #856404; }
        .status-processing { background: #cfe2ff; color: #084298; }
        .status-resolved { background: #d1e7dd; color: #0f5132; }
        .status-closed { background: #f8d7da; color: #842029; }
        .form-group {
            margin-bottom: 20px;
        }
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #333;
        }
        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
        }
        .form-group textarea {
            min-height: 100px;
            resize: vertical;
        }
        .alert {
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 20px;
        }
        .alert-success {
            background: #d1e7dd;
            color: #0f5132;
        }
        .alert-error {
            background: #f8d7da;
            color: #842029;
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            overflow: auto;
        }
        .modal.show {
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background-color: white;
            margin: auto;
            padding: 30px;
            border-radius: 8px;
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #eee;
        }
        .modal-header h3 {
            margin: 0;
            color: #667eea;
        }
        .close {
            color: #aaa;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            border: none;
            background: none;
        }
        .close:hover {
            color: #000;
        }
        .event-detail {
            margin-bottom: 15px;
        }
        .event-detail label {
            font-weight: 600;
            color: #333;
            display: block;
            margin-bottom: 5px;
        }
        .event-detail .value {
            color: #666;
            padding: 8px;
            background: #f8f9fa;
            border-radius: 4px;
        }
        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background: #f5f7fa;
        }
        .login-card {
            background: white;
            width: 360px;
            padding: 40px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        .login-card h2 {
            text-align: center;
            margin-bottom: 30px;
            color: #667eea;
        }
        .input-group {
            margin-bottom: 20px;
        }
        .input-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #333;
        }
        .input-group input {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
        }
        .login-btn {
            width: 100%;
            padding: 12px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s;
        }
        .login-btn:hover {
            background: #5568d3;
        }
    </style>
</head>
<body>
<div id="app">
    <!-- ç™»å½•ç•Œé¢ -->
    <div v-if="!isLoggedIn" class="login-container">
        <div class="login-card">
            <h2>ğŸ« æ ¡å›­åº”æ€¥å“åº”ç³»ç»Ÿ</h2>
            <div v-if="message" class="alert" :class="messageType">{{ message }}</div>
            <form @submit.prevent="login">
                <div class="input-group">
                    <label>è´¦å·</label>
                    <input v-model="loginForm.username" placeholder="è¯·è¾“å…¥å­¦å·/å·¥å·" required/>
                </div>
                <div class="input-group">
                    <label>å¯†ç </label>
                    <input type="password" v-model="loginForm.password" placeholder="è¯·è¾“å…¥å¯†ç " required/>
                </div>
                <button type="submit" class="login-btn">ç™»å½•</button>
            </form>
        </div>
    </div>

    <!-- ä¸»ç•Œé¢ -->
    <div v-else>
        <div class="header">
            <h1>ğŸ« æ ¡å›­çªå‘äº‹ä»¶åº”æ€¥å“åº”ç³»ç»Ÿ</h1>
            <div class="user-info">
                <span>æ¬¢è¿ï¼Œ{{ user.name }} ({{ user.role }})</span>
                <button class="btn btn-danger" @click="logout">é€€å‡ºç™»å½•</button>
            </div>
        </div>

        <div class="nav">
            <button class="nav-btn" :class="{active: currentPage === 'dashboard'}" @click="currentPage = 'dashboard'">é¦–é¡µ</button>
            <button class="nav-btn" :class="{active: currentPage === 'event'}" @click="currentPage = 'event'">äº‹ä»¶ä¸ŠæŠ¥</button>
            <button class="nav-btn" :class="{active: currentPage === 'resource'}" @click="currentPage = 'resource'">èµ„æºè°ƒåº¦</button>
            <button class="nav-btn" :class="{active: currentPage === 'command'}" @click="currentPage = 'command'">åº”æ€¥æŒ‡æŒ¥</button>
            <button class="nav-btn" :class="{active: currentPage === 'announcement'}" @click="currentPage = 'announcement'">ä¿¡æ¯å‘å¸ƒ</button>
        </div>

        <div class="container">
            <div class="content">
            <!-- é¦–é¡µ -->
            <div v-if="currentPage === 'dashboard'">
                <h2>ç³»ç»Ÿæ¦‚è§ˆ</h2>
                <div class="stats">
                    <div class="stat-card">
                        <h3>{{ stats.totalEvents }}</h3>
                        <p>æ€»äº‹ä»¶æ•°</p>
                    </div>
                    <div class="stat-card">
                        <h3>{{ stats.pendingEvents }}</h3>
                        <p>å¾…å¤„ç†äº‹ä»¶</p>
                    </div>
                    <div class="stat-card">
                        <h3>{{ stats.totalResources }}</h3>
                        <p>å¯ç”¨èµ„æº</p>
                    </div>
                    <div class="stat-card">
                        <h3>{{ stats.activeCommands }}</h3>
                        <p>æ‰§è¡Œä¸­æŒ‡ä»¤</p>
                    </div>
                </div>
                <h3 style="margin-top: 30px;">æœ€è¿‘äº‹ä»¶</h3>
                <table>
                    <thead>
                        <tr>
                            <th>æ ‡é¢˜</th>
                            <th>ç±»å‹</th>
                            <th>çº§åˆ«</th>
                            <th>çŠ¶æ€</th>
                            <th>ä¸ŠæŠ¥æ—¶é—´</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr v-for="event in recentEvents" :key="event.id">
                            <td>{{ event.title }}</td>
                            <td>{{ event.type }}</td>
                            <td>{{ event.level }}</td>
                            <td><span class="status-badge" :class="'status-' + event.status">{{ event.status }}</span></td>
                            <td>{{ formatTime(event.reportTime) }}</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- äº‹ä»¶ä¸ŠæŠ¥ -->
            <div v-if="currentPage === 'event'">
                <h2>äº‹ä»¶ä¸ŠæŠ¥</h2>
                <div v-if="message" class="alert" :class="messageType">{{ message }}</div>
                <form @submit.prevent="reportEvent">
                    <div class="form-group">
                        <label>äº‹ä»¶æ ‡é¢˜ *</label>
                        <input v-model="eventForm.title" required placeholder="è¯·è¾“å…¥äº‹ä»¶æ ‡é¢˜"/>
                    </div>
                    <div class="form-group">
                        <label>äº‹ä»¶ç±»å‹ *</label>
                        <select v-model="eventForm.type" required>
                            <option value="">è¯·é€‰æ‹©</option>
                            <option value="fire">ç«ç¾</option>
                            <option value="earthquake">åœ°éœ‡</option>
                            <option value="medical">åŒ»ç–—</option>
                            <option value="security">å®‰å…¨</option>
                            <option value="other">å…¶ä»–</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>äº‹ä»¶çº§åˆ« *</label>
                        <select v-model="eventForm.level" required>
                            <option value="low">ä½</option>
                            <option value="normal">ä¸€èˆ¬</option>
                            <option value="high">é«˜</option>
                            <option value="urgent">ç´§æ€¥</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>äº‹ä»¶åœ°ç‚¹ *</label>
                        <input v-model="eventForm.location" required placeholder="è¯·è¾“å…¥äº‹ä»¶åœ°ç‚¹"/>
                    </div>
                    <div class="form-group">
                        <label>äº‹ä»¶æè¿° *</label>
                        <textarea v-model="eventForm.description" required placeholder="è¯·è¯¦ç»†æè¿°äº‹ä»¶æƒ…å†µ"></textarea>
                    </div>
                    <button type="submit" class="btn">æäº¤ä¸ŠæŠ¥</button>
                </form>
                <h3 style="margin-top: 40px;">æˆ‘çš„ä¸ŠæŠ¥è®°å½•</h3>
                <table>
                    <thead>
                        <tr>
                            <th>æ ‡é¢˜</th>
                            <th>ç±»å‹</th>
                            <th>çº§åˆ«</th>
                            <th>çŠ¶æ€</th>
                            <th>ä¸ŠæŠ¥æ—¶é—´</th>
                            <th>æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr v-for="event in myEvents" :key="event.id">
                            <td>{{ event.title }}</td>
                            <td>{{ event.type }}</td>
                            <td>{{ event.level }}</td>
                            <td><span class="status-badge" :class="'status-' + event.status">{{ event.status }}</span></td>
                            <td>{{ formatTime(event.reportTime) }}</td>
                            <td>
                                <button class="btn" @click="viewEvent(event.id)">æŸ¥çœ‹</button>
                                <button v-if="event.status === 'pending'" class="btn btn-success" style="margin-left: 5px;" @click="editEvent(event)">ä¿®æ”¹</button>
                                <button v-if="event.status === 'pending'" class="btn btn-danger" style="margin-left: 5px;" @click="confirmDeleteEvent(event)">åˆ é™¤</button>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- èµ„æºè°ƒåº¦ -->
            <div v-if="currentPage === 'resource'">
                <h2>èµ„æºè°ƒåº¦</h2>
                <div v-if="message" class="alert" :class="messageType">{{ message }}</div>
                <h3>å¯ç”¨èµ„æºåˆ—è¡¨</h3>
                <table>
                    <thead>
                        <tr>
                            <th>èµ„æºåç§°</th>
                            <th>ç±»å‹</th>
                            <th>ä½ç½®</th>
                            <th>å¯ç”¨æ•°é‡</th>
                            <th>çŠ¶æ€</th>
                            <th>æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr v-for="resource in resources" :key="resource.id">
                            <td>{{ resource.name }}</td>
                            <td>{{ resource.type }}</td>
                            <td>{{ resource.location }}</td>
                            <td>{{ resource.availableQuantity }}/{{ resource.quantity }}</td>
                            <td><span class="status-badge" :class="'status-' + resource.status">{{ resource.status }}</span></td>
                            <td>
                                <button class="btn" @click="showDispatchDialog(resource)">è°ƒåº¦</button>
                            </td>
                        </tr>
                    </tbody>
                </table>
                <h3 style="margin-top: 40px;">è°ƒåº¦è®°å½•</h3>
                <table>
                    <thead>
                        <tr>
                            <th>èµ„æºåç§°</th>
                            <th>å…³è”äº‹ä»¶</th>
                            <th>è°ƒåº¦æ•°é‡</th>
                            <th>çŠ¶æ€</th>
                            <th>è°ƒåº¦æ—¶é—´</th>
                            <th>æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr v-for="dispatch in dispatches" :key="dispatch.id">
                            <td>{{ dispatch.resourceName }}</td>
                            <td>{{ dispatch.eventId }}</td>
                            <td>{{ dispatch.dispatchQuantity }}</td>
                            <td><span class="status-badge" :class="'status-' + dispatch.status">{{ dispatch.status }}</span></td>
                            <td>{{ formatTime(dispatch.dispatchTime) }}</td>
                            <td>
                                <button v-if="dispatch.status === 'dispatched'" class="btn btn-success" @click="arriveResource(dispatch.id)">åˆ°è¾¾</button>
                                <button v-if="dispatch.status === 'arrived'" class="btn btn-success" @click="completeDispatch(dispatch.id)">å®Œæˆ</button>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- åº”æ€¥æŒ‡æŒ¥ -->
            <div v-if="currentPage === 'command'">
                <h2>åº”æ€¥æŒ‡æŒ¥</h2>
                <div v-if="message" class="alert" :class="messageType">{{ message }}</div>
                <form v-if="user.role === 'commander' || user.role === 'admin'" @submit.prevent="issueCommand">
                    <div class="form-group">
                        <label>æŒ‡ä»¤æ ‡é¢˜ *</label>
                        <input v-model="commandForm.title" required placeholder="è¯·è¾“å…¥æŒ‡ä»¤æ ‡é¢˜"/>
                    </div>
                    <div class="form-group">
                        <label>å…³è”äº‹ä»¶ID</label>
                        <input v-model="commandForm.eventId" placeholder="å¯é€‰ï¼Œå…³è”åˆ°å…·ä½“äº‹ä»¶"/>
                    </div>
                    <div class="form-group">
                        <label>æŒ‡ä»¤å†…å®¹ *</label>
                        <textarea v-model="commandForm.content" required placeholder="è¯·è¾“å…¥æŒ‡ä»¤å†…å®¹"></textarea>
                    </div>
                    <div class="form-group">
                        <label>ä¼˜å…ˆçº§</label>
                        <select v-model="commandForm.priority">
                            <option value="low">ä½</option>
                            <option value="normal">ä¸€èˆ¬</option>
                            <option value="high">é«˜</option>
                            <option value="urgent">ç´§æ€¥</option>
                        </select>
                    </div>
                    <button type="submit" class="btn">å‘å¸ƒæŒ‡ä»¤</button>
                </form>
                <h3 style="margin-top: 40px;">æŒ‡ä»¤åˆ—è¡¨</h3>
                <table>
                    <thead>
                        <tr>
                            <th>æ ‡é¢˜</th>
                            <th>ä¼˜å…ˆçº§</th>
                            <th>çŠ¶æ€</th>
                            <th>å‘å¸ƒäºº</th>
                            <th>æ‰§è¡Œäºº</th>
                            <th>å‘å¸ƒæ—¶é—´</th>
                            <th>æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr v-for="command in commands" :key="command.id">
                            <td>{{ command.title }}</td>
                            <td>{{ command.priority }}</td>
                            <td><span class="status-badge" :class="'status-' + command.status">{{ command.status }}</span></td>
                            <td>{{ command.commanderName }}</td>
                            <td>{{ command.executorName || '-' }}</td>
                            <td>{{ formatTime(command.issueTime) }}</td>
                            <td>
                                <button v-if="command.status === 'pending' && user.role !== 'commander'" class="btn" @click="executeCommand(command.id)">æ‰§è¡Œ</button>
                                <button v-if="command.status === 'executing'" class="btn btn-success" @click="completeCommand(command.id)">å®Œæˆ</button>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- ä¿¡æ¯å‘å¸ƒ -->
            <div v-if="currentPage === 'announcement'">
                <h2>ä¿¡æ¯å‘å¸ƒ</h2>
                <div v-if="message" class="alert" :class="messageType">{{ message }}</div>
                <form @submit.prevent="publishAnnouncement">
                    <div class="form-group">
                        <label>æ ‡é¢˜ *</label>
                        <input v-model="announcementForm.title" required placeholder="è¯·è¾“å…¥æ ‡é¢˜"/>
                    </div>
                    <div class="form-group">
                        <label>å†…å®¹ *</label>
                        <textarea v-model="announcementForm.content" required placeholder="è¯·è¾“å…¥å†…å®¹"></textarea>
                    </div>
                    <div class="form-group">
                        <label>ç±»å‹</label>
                        <select v-model="announcementForm.type">
                            <option value="notice">é€šçŸ¥</option>
                            <option value="warning">é¢„è­¦</option>
                            <option value="update">æ›´æ–°</option>
                            <option value="other">å…¶ä»–</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>ç›®æ ‡å—ä¼—</label>
                        <select v-model="announcementForm.targetAudience">
                            <option value="all">å…¨éƒ¨</option>
                            <option value="student">å­¦ç”Ÿ</option>
                            <option value="teacher">æ•™å¸ˆ</option>
                            <option value="staff">å‘˜å·¥</option>
                        </select>
                    </div>
                    <button type="submit" class="btn">å‘å¸ƒ</button>
                </form>
                <h3 style="margin-top: 40px;">å·²å‘å¸ƒä¿¡æ¯</h3>
                <table>
                    <thead>
                        <tr>
                            <th>æ ‡é¢˜</th>
                            <th>ç±»å‹</th>
                            <th>å‘å¸ƒäºº</th>
                            <th>å‘å¸ƒæ—¶é—´</th>
                            <th>æŸ¥çœ‹æ¬¡æ•°</th>
                            <th>æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr v-for="announcement in announcements" :key="announcement.id">
                            <td>{{ announcement.title }}</td>
                            <td>{{ announcement.type }}</td>
                            <td>{{ announcement.publisherName }}</td>
                            <td>{{ formatTime(announcement.publishTime) }}</td>
                            <td>{{ announcement.viewCount }}</td>
                            <td>
                                <button class="btn" @click="viewAnnouncement(announcement.id)">æŸ¥çœ‹</button>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
        </div>
    </div>

    <!-- æŸ¥çœ‹äº‹ä»¶è¯¦æƒ…æ¨¡æ€æ¡† -->
    <div id="eventDetailModal" class="modal" :class="{show: showEventDetail}" @click.self="closeEventDetail">
        <div class="modal-content" @click.stop>
            <div class="modal-header">
                <h3>äº‹ä»¶è¯¦æƒ…</h3>
                <button class="close" @click="closeEventDetail">&times;</button>
            </div>
            <div v-if="currentEvent">
                <div class="event-detail">
                    <label>äº‹ä»¶æ ‡é¢˜</label>
                    <div class="value">{{ currentEvent.title }}</div>
                </div>
                <div class="event-detail">
                    <label>äº‹ä»¶ç±»å‹</label>
                    <div class="value">{{ getEventTypeName(currentEvent.type) }}</div>
                </div>
                <div class="event-detail">
                    <label>äº‹ä»¶çº§åˆ«</label>
                    <div class="value">{{ getEventLevelName(currentEvent.level) }}</div>
                </div>
                <div class="event-detail">
                    <label>äº‹ä»¶åœ°ç‚¹</label>
                    <div class="value">{{ currentEvent.location }}</div>
                </div>
                <div class="event-detail">
                    <label>äº‹ä»¶æè¿°</label>
                    <div class="value" style="white-space: pre-wrap;">{{ currentEvent.description }}</div>
                </div>
                <div class="event-detail">
                    <label>çŠ¶æ€</label>
                    <div class="value"><span class="status-badge" :class="'status-' + currentEvent.status">{{ getEventStatusName(currentEvent.status) }}</span></div>
                </div>
                <div class="event-detail">
                    <label>ä¸ŠæŠ¥äºº</label>
                    <div class="value">{{ currentEvent.reporterName }}</div>
                </div>
                <div class="event-detail">
                    <label>ä¸ŠæŠ¥æ—¶é—´</label>
                    <div class="value">{{ formatTime(currentEvent.reportTime) }}</div>
                </div>
                <div v-if="currentEvent.handlerName" class="event-detail">
                    <label>å¤„ç†äºº</label>
                    <div class="value">{{ currentEvent.handlerName }}</div>
                </div>
                <div v-if="currentEvent.handleTime" class="event-detail">
                    <label>å¤„ç†æ—¶é—´</label>
                    <div class="value">{{ formatTime(currentEvent.handleTime) }}</div>
                </div>
                <div v-if="currentEvent.resolveTime" class="event-detail">
                    <label>è§£å†³æ—¶é—´</label>
                    <div class="value">{{ formatTime(currentEvent.resolveTime) }}</div>
                </div>
            </div>
        </div>
    </div>

    <!-- ä¿®æ”¹äº‹ä»¶æ¨¡æ€æ¡† -->
    <div id="editEventModal" class="modal" :class="{show: showEditEvent}" @click.self="closeEditEvent">
        <div class="modal-content" @click.stop>
            <div class="modal-header">
                <h3>ä¿®æ”¹äº‹ä»¶</h3>
                <button class="close" @click="closeEditEvent">&times;</button>
            </div>
            <div v-if="editEventForm.id">
                <div v-if="message" class="alert" :class="messageType">{{ message }}</div>
                <form @submit.prevent="updateEvent">
                    <div class="form-group">
                        <label>äº‹ä»¶æ ‡é¢˜ *</label>
                        <input v-model="editEventForm.title" required placeholder="è¯·è¾“å…¥äº‹ä»¶æ ‡é¢˜"/>
                    </div>
                    <div class="form-group">
                        <label>äº‹ä»¶ç±»å‹ *</label>
                        <select v-model="editEventForm.type" required>
                            <option value="">è¯·é€‰æ‹©</option>
                            <option value="fire">ç«ç¾</option>
                            <option value="earthquake">åœ°éœ‡</option>
                            <option value="medical">åŒ»ç–—</option>
                            <option value="security">å®‰å…¨</option>
                            <option value="other">å…¶ä»–</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>äº‹ä»¶çº§åˆ« *</label>
                        <select v-model="editEventForm.level" required>
                            <option value="low">ä½</option>
                            <option value="normal">ä¸€èˆ¬</option>
                            <option value="high">é«˜</option>
                            <option value="urgent">ç´§æ€¥</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>äº‹ä»¶åœ°ç‚¹ *</label>
                        <input v-model="editEventForm.location" required placeholder="è¯·è¾“å…¥äº‹ä»¶åœ°ç‚¹"/>
                    </div>
                    <div class="form-group">
                        <label>äº‹ä»¶æè¿° *</label>
                        <textarea v-model="editEventForm.description" required placeholder="è¯·è¯¦ç»†æè¿°äº‹ä»¶æƒ…å†µ"></textarea>
                    </div>
                    <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
                        <button type="button" class="btn" style="background: #6c757d;" @click="closeEditEvent">å–æ¶ˆ</button>
                        <button type="submit" class="btn">ä¿å­˜ä¿®æ”¹</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
const { createApp } = Vue;

createApp({
    data() {
        return {
            isLoggedIn: false,
            user: { name: 'ç”¨æˆ·', role: 'student' },
            currentPage: 'dashboard',
            message: '',
            messageType: '',
            loginForm: {
                username: '',
                password: ''
            },
            stats: {
                totalEvents: 0,
                pendingEvents: 0,
                totalResources: 0,
                activeCommands: 0
            },
            recentEvents: [],
            myEvents: [],
            resources: [],
            dispatches: [],
            commands: [],
            announcements: [],
            eventForm: {
                title: '',
                type: '',
                level: 'normal',
                location: '',
                description: ''
            },
            commandForm: {
                title: '',
                eventId: '',
                content: '',
                priority: 'normal'
            },
            announcementForm: {
                title: '',
                content: '',
                type: 'notice',
                targetAudience: 'all'
            },
            showEventDetail: false,
            showEditEvent: false,
            currentEvent: null,
            editEventForm: {
                id: '',
                title: '',
                type: '',
                level: '',
                location: '',
                description: ''
            }
        }
    },
    mounted() {
        this.checkLogin();
    },
    watch: {
        currentPage(newPage) {
            if (!this.isLoggedIn) return;
            if (newPage === 'event') {
                this.loadMyEvents();
            } else if (newPage === 'resource') {
                this.loadResources();
                this.loadDispatches();
            } else if (newPage === 'command') {
                this.loadCommands();
            } else if (newPage === 'announcement') {
                this.loadAnnouncements();
            }
        }
    },
    methods: {
        checkLogin() {
            const userStr = localStorage.getItem('user');
            if (userStr) {
                this.user = JSON.parse(userStr);
                this.isLoggedIn = true;
                this.loadDashboard();
            } else {
                this.isLoggedIn = false;
            }
        },
        async login() {
            this.message = 'ç™»å½•ä¸­...';
            this.messageType = '';
            try {
                const res = await fetch('/api/user/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        username: this.loginForm.username,
                        password: this.loginForm.password
                    })
                });
                const data = await res.json();
                if (res.ok && data.success) {
                    this.message = 'ç™»å½•æˆåŠŸ';
                    this.messageType = 'alert-success';
                    localStorage.setItem('user', JSON.stringify(data.user));
                    this.user = data.user;
                    this.isLoggedIn = true;
                    this.loginForm = { username: '', password: '' };
                    this.loadDashboard();
                } else {
                    this.message = data.message || 'è´¦å·æˆ–å¯†ç é”™è¯¯';
                    this.messageType = 'alert-error';
                }
            } catch (err) {
                this.message = 'ç½‘ç»œé”™è¯¯ï¼Œæ— æ³•è¿æ¥æœåŠ¡å™¨';
                this.messageType = 'alert-error';
            }
        },
        logout() {
            localStorage.removeItem('user');
            this.isLoggedIn = false;
            this.user = { name: 'ç”¨æˆ·', role: 'student' };
            this.currentPage = 'dashboard';
            this.message = '';
            this.messageType = '';
        },
        async loadDashboard() {
            try {
                const [eventsRes, resourcesRes, commandsRes] = await Promise.all([
                    fetch('/api/event/list'),
                    fetch('/api/resource/list?status=available'),
                    fetch('/api/command/list?status=executing')
                ]);
                const events = await eventsRes.json();
                const resources = await resourcesRes.json();
                const commands = await commandsRes.json();
                
                this.stats.totalEvents = events.data?.length || 0;
                this.stats.pendingEvents = events.data?.filter(e => e.status === 'pending').length || 0;
                this.stats.totalResources = resources.data?.length || 0;
                this.stats.activeCommands = commands.data?.length || 0;
                this.recentEvents = events.data?.slice(0, 10) || [];
            } catch (err) {
                console.error(err);
            }
        },
        async reportEvent() {
            try {
                const res = await fetch('/api/event/report', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        ...this.eventForm,
                        reporterId: this.user.id,
                        reporterName: this.user.name
                    })
                });
                const data = await res.json();
                if (data.success) {
                    this.showMessage('äº‹ä»¶ä¸ŠæŠ¥æˆåŠŸ', 'success');
                    this.eventForm = { title: '', type: '', level: 'normal', location: '', description: '' };
                    this.loadMyEvents();
                } else {
                    this.showMessage(data.message || 'ä¸ŠæŠ¥å¤±è´¥', 'error');
                }
            } catch (err) {
                this.showMessage('ç½‘ç»œé”™è¯¯', 'error');
            }
        },
        async loadMyEvents() {
            try {
                const res = await fetch(`/api/event/list?reporterId=${this.user.id}`);
                const data = await res.json();
                this.myEvents = data.data || [];
            } catch (err) {
                console.error(err);
            }
        },
        async loadResources() {
            try {
                const res = await fetch('/api/resource/list');
                const data = await res.json();
                this.resources = data.data || [];
            } catch (err) {
                console.error(err);
            }
        },
        async loadDispatches() {
            try {
                const res = await fetch('/api/dispatch/list');
                const data = await res.json();
                this.dispatches = data.data || [];
            } catch (err) {
                console.error(err);
            }
        },
        showDispatchDialog(resource) {
            const eventId = prompt('è¯·è¾“å…¥å…³è”çš„äº‹ä»¶ID:');
            const quantity = prompt(`è¯·è¾“å…¥è°ƒåº¦æ•°é‡ (å¯ç”¨: ${resource.availableQuantity}):`);
            if (eventId && quantity) {
                this.dispatchResource(resource.id, resource.name, eventId, parseInt(quantity));
            }
        },
        async dispatchResource(resourceId, resourceName, eventId, quantity) {
            try {
                const res = await fetch('/api/dispatch/dispatch', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        resourceId,
                        resourceName,
                        eventId,
                        dispatchQuantity: quantity,
                        dispatcherId: this.user.id,
                        dispatcherName: this.user.name
                    })
                });
                const data = await res.json();
                if (data.success) {
                    this.showMessage('èµ„æºè°ƒåº¦æˆåŠŸ', 'success');
                    this.loadResources();
                    this.loadDispatches();
                } else {
                    this.showMessage(data.message || 'è°ƒåº¦å¤±è´¥', 'error');
                }
            } catch (err) {
                this.showMessage('ç½‘ç»œé”™è¯¯', 'error');
            }
        },
        async arriveResource(id) {
            try {
                const res = await fetch(`/api/dispatch/arrive/${id}`, { method: 'PUT' });
                const data = await res.json();
                if (data.success) {
                    this.showMessage('èµ„æºå·²åˆ°è¾¾', 'success');
                    this.loadDispatches();
                }
            } catch (err) {
                this.showMessage('ç½‘ç»œé”™è¯¯', 'error');
            }
        },
        async completeDispatch(id) {
            try {
                const res = await fetch(`/api/dispatch/complete/${id}`, { method: 'PUT' });
                const data = await res.json();
                if (data.success) {
                    this.showMessage('è°ƒåº¦å·²å®Œæˆ', 'success');
                    this.loadResources();
                    this.loadDispatches();
                }
            } catch (err) {
                this.showMessage('ç½‘ç»œé”™è¯¯', 'error');
            }
        },
        async issueCommand() {
            try {
                const res = await fetch('/api/command/issue', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        ...this.commandForm,
                        commanderId: this.user.id,
                        commanderName: this.user.name
                    })
                });
                const data = await res.json();
                if (data.success) {
                    this.showMessage('æŒ‡ä»¤å‘å¸ƒæˆåŠŸ', 'success');
                    this.commandForm = { title: '', eventId: '', content: '', priority: 'normal' };
                    this.loadCommands();
                } else {
                    this.showMessage(data.message || 'å‘å¸ƒå¤±è´¥', 'error');
                }
            } catch (err) {
                this.showMessage('ç½‘ç»œé”™è¯¯', 'error');
            }
        },
        async loadCommands() {
            try {
                const res = await fetch('/api/command/list');
                const data = await res.json();
                this.commands = data.data || [];
            } catch (err) {
                console.error(err);
            }
        },
        async executeCommand(id) {
            try {
                const res = await fetch(`/api/command/execute/${id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        executorId: this.user.id,
                        executorName: this.user.name
                    })
                });
                const data = await res.json();
                if (data.success) {
                    this.showMessage('æŒ‡ä»¤æ‰§è¡Œä¸­', 'success');
                    this.loadCommands();
                }
            } catch (err) {
                this.showMessage('ç½‘ç»œé”™è¯¯', 'error');
            }
        },
        async completeCommand(id) {
            try {
                const res = await fetch(`/api/command/complete/${id}`, { method: 'PUT' });
                const data = await res.json();
                if (data.success) {
                    this.showMessage('æŒ‡ä»¤å·²å®Œæˆ', 'success');
                    this.loadCommands();
                }
            } catch (err) {
                this.showMessage('ç½‘ç»œé”™è¯¯', 'error');
            }
        },
        async publishAnnouncement() {
            try {
                const res = await fetch('/api/announcement/publish', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        ...this.announcementForm,
                        publisherId: this.user.id,
                        publisherName: this.user.name
                    })
                });
                const data = await res.json();
                if (data.success) {
                    this.showMessage('ä¿¡æ¯å‘å¸ƒæˆåŠŸ', 'success');
                    this.announcementForm = { title: '', content: '', type: 'notice', targetAudience: 'all' };
                    this.loadAnnouncements();
                } else {
                    this.showMessage(data.message || 'å‘å¸ƒå¤±è´¥', 'error');
                }
            } catch (err) {
                this.showMessage('ç½‘ç»œé”™è¯¯', 'error');
            }
        },
        async loadAnnouncements() {
            try {
                const res = await fetch('/api/announcement/list?status=published');
                const data = await res.json();
                this.announcements = data.data || [];
            } catch (err) {
                console.error(err);
            }
        },
        async viewAnnouncement(id) {
            try {
                const res = await fetch(`/api/announcement/${id}`);
                const data = await res.json();
                if (data.success) {
                    alert(`æ ‡é¢˜: ${data.data.title}\n\nå†…å®¹: ${data.data.content}\n\nå‘å¸ƒæ—¶é—´: ${this.formatTime(data.data.publishTime)}`);
                    this.loadAnnouncements();
                }
            } catch (err) {
                this.showMessage('ç½‘ç»œé”™è¯¯', 'error');
            }
        },
        async viewEvent(id) {
            try {
                const res = await fetch(`/api/event/${id}`);
                const data = await res.json();
                if (data.success) {
                    this.currentEvent = data.data;
                    this.showEventDetail = true;
                } else {
                    this.showMessage(data.message || 'è·å–äº‹ä»¶è¯¦æƒ…å¤±è´¥', 'error');
                }
            } catch (err) {
                this.showMessage('ç½‘ç»œé”™è¯¯', 'error');
            }
        },
        closeEventDetail() {
            this.showEventDetail = false;
            this.currentEvent = null;
        },
        editEvent(event) {
            this.editEventForm = {
                id: event.id,
                title: event.title,
                type: event.type,
                level: event.level,
                location: event.location,
                description: event.description
            };
            this.showEditEvent = true;
        },
        closeEditEvent() {
            this.showEditEvent = false;
            this.editEventForm = {
                id: '',
                title: '',
                type: '',
                level: '',
                location: '',
                description: ''
            };
        },
        async updateEvent() {
            try {
                const res = await fetch('/api/event/update', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        ...this.editEventForm,
                        reporterId: this.user.id
                    })
                });
                const data = await res.json();
                if (data.success) {
                    this.showMessage('äº‹ä»¶ä¿®æ”¹æˆåŠŸ', 'success');
                    this.closeEditEvent();
                    this.loadMyEvents();
                } else {
                    this.showMessage(data.message || 'ä¿®æ”¹å¤±è´¥', 'error');
                }
            } catch (err) {
                this.showMessage('ç½‘ç»œé”™è¯¯', 'error');
            }
        },
        getEventTypeName(type) {
            const types = {
                'fire': 'ç«ç¾',
                'earthquake': 'åœ°éœ‡',
                'medical': 'åŒ»ç–—',
                'security': 'å®‰å…¨',
                'other': 'å…¶ä»–'
            };
            return types[type] || type;
        },
        getEventLevelName(level) {
            const levels = {
                'low': 'ä½',
                'normal': 'ä¸€èˆ¬',
                'high': 'é«˜',
                'urgent': 'ç´§æ€¥'
            };
            return levels[level] || level;
        },
        getEventStatusName(status) {
            const statuses = {
                'pending': 'å¾…å¤„ç†',
                'processing': 'å¤„ç†ä¸­',
                'resolved': 'å·²è§£å†³',
                'closed': 'å·²å…³é—­'
            };
            return statuses[status] || status;
        },
        confirmDeleteEvent(event) {
            if (confirm(`ç¡®å®šè¦åˆ é™¤äº‹ä»¶"${event.title}"å—ï¼Ÿåˆ é™¤åæ— æ³•æ¢å¤ã€‚`)) {
                this.deleteEvent(event.id);
            }
        },
        async deleteEvent(eventId) {
            try {
                const res = await fetch(`/api/event/${eventId}?reporterId=${this.user.id}`, {
                    method: 'DELETE'
                });
                const data = await res.json();
                if (data.success) {
                    this.showMessage('äº‹ä»¶åˆ é™¤æˆåŠŸ', 'success');
                    this.loadMyEvents();
                } else {
                    this.showMessage(data.message || 'åˆ é™¤å¤±è´¥', 'error');
                }
            } catch (err) {
                this.showMessage('ç½‘ç»œé”™è¯¯', 'error');
            }
        },
        formatTime(timeStr) {
            if (!timeStr) return '-';
            return new Date(timeStr).toLocaleString('zh-CN');
        },
        showMessage(msg, type) {
            this.message = msg;
            this.messageType = type === 'success' ? 'alert-success' : 'alert-error';
            setTimeout(() => {
                this.message = '';
                this.messageType = '';
            }, 3000);
        }
    }
}).mount("#app");
</script>
</body>
</html>

